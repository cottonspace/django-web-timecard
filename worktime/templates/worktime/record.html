{% extends 'worktime/base.html' %}
{% load static %}
{% block title %}打刻 | {{ block.super }}{% endblock title %}
{% block main %}
<style>
    @import url("https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap");

    #clock-time {
        font-family: 'Share Tech Mono', monospace;
        font-size: 100px;
    }

    #clock-second {
        font-family: 'Share Tech Mono', monospace;
        font-size: 32px;
    }
</style>
<div class="container text-center">
    <div class="row">
        <div class="col">
            <h2><span id="clock-date"></span> {{ display_name }}</h2>
        </div>
    </div>
    <div class="row">
        <div class="col"><span id="clock-time"></span><span id="clock-second"></span></div>
    </div>
</div>
<form id="record" method="post">
    {% csrf_token %}
    {{ form }}
    <div class="row justify-content-center">
        <div class="col-5">
            <div class="card">
                <img src="{% static 'worktime/image_begin.png' %}" style="max-width:100%; object-fit:cover;">
                <div class="card-body d-grid">
                    <button type="button" class="btn btn-primary btn-lg" onclick="record('begin')">出勤</button>
                </div>
            </div>
        </div>
        <div class="col-5">
            <div class="card">
                <img src="{% static 'worktime/image_end.png' %}" style="max-width:100%; object-fit:cover;">
                <div class="card-body d-grid">
                    <button type="button" class="btn btn-secondary btn-lg" onclick="record('end')">退勤</button>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="row justify-content-center">
    <div class="col-8 m-3">
        <ul class="list-group">
            <li class="list-group-item active" aria-current="true">最近 3 日間の打刻</li>
            {% for history in recent %}
            <li class="list-group-item">{{ history.date|date:"n月j日(D)" }} {{ history.time|date:"H:i" }} {% if history.action == "begin" %}出勤{% elif history.action == "end" %}退勤{% endif %}</li>
            {% endfor %}
        </ul>
    </div>
</div>
<script>
    function show_clock() {
        let now = new Date();
        document.getElementById("clock-date").textContent = String(now.getMonth() + 1) + '/' + String(now.getDate()) + '(' + ['日', '月', '火', '水', '木', '金', '土'][now.getDay()] + ')'
        document.getElementById("clock-time").textContent = String(now.getHours()).padStart(2, "0") + ':' + String(now.getMinutes()).padStart(2, "0");
        document.getElementById("clock-second").textContent = ':' + String(now.getSeconds()).padStart(2, "0");
        setTimeout(show_clock, 1000);
    }
    async function record(action) {
        document.getElementsByName('action')[0].value = action;
        document.getElementsByName('ua')[0].value = navigator.userAgent;
        {% if is_enable_check_location %}
        try {
            let position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0,
                });
            });
            document.getElementsByName('latitude')[0].value = position.coords.latitude;
            document.getElementsByName('longitude')[0].value = position.coords.longitude;
            document.getElementsByName('accuracy')[0].value = position.coords.accuracy;
        } catch (err) {
            console.log(err)
        }
        {% endif %}
        document.getElementById('record').submit();
    }
    show_clock();
</script>
{% endblock main %}